### Prepare machines ##########################################################
- hosts: all
  vars_files: 
    - vars.yml
    - "{{ vars_local | default('vars.yml') }}"

  roles:
    - role: prepare-all 

###############################################################################
### Clean slate ###############################################################
###############################################################################

- hosts: all
  vars_files: 
    - vars.yml
  roles:
    - role: clean-slate
      when: clean_slate


###############################################################################
### Server phase 1 ############################################################
###############################################################################

- hosts: cider-ci-server
  vars_files: 
    - vars.yml
    - vars-server.yml
    - "{{ vars_local | default('vars.yml') }}"
  roles: 
    - role: server-apache2
    - role: server-reverse-proxy
      reverse_proxy_enabled: False


###############################################################################
### executors #################################################################
###############################################################################

- hosts: cider-ci-executors

  vars_files: 
    - vars.yml
    - vars-server.yml
    - vars-executors.yml
    - "{{ vars_local | default('vars.yml') }}"

  roles: 

    - role: project-checkout
      cider_ci_git_ref: "{{ lookup('pipe','cd  ./../. && git log -n 1 --format=%H') }}"

    - role: executor-secrets

    - role: executor-user
      user: '{{executor_execution_user}}'

    - role: executor-config

    - role: lein-service
      lein_service_name: cider-ci_executor
      lein_service_app_dir: /var/local/cider-ci/executor
      lein_service_user: root 

    - role: nightly-reboot


###############################################################################
### server phase 2 ############################################################
###############################################################################


- hosts: cider-ci-server
  vars_files: 
    - vars.yml
    - vars-server.yml
    - "{{ vars_local | default('vars.yml') }}"

  roles: 

    - role: project-checkout
      cider_ci_git_ref: "{{ lookup('pipe','cd  ./../. && git log -n 1 --format=%H') }}"

    - role: postgresql
      postgresql_version: 9.4
      port: 5432

    - role: rabbitmq

    - role: server-common

    - role: user-interface

    - role: lein-service
      lein_service_name: cider-ci_api
      lein_service_app_dir: /var/local/cider-ci/api
      lein_service_user: cider-ci_api

    - role: lein-service
      lein_service_name: cider-ci_builder
      lein_service_app_dir: /var/local/cider-ci/builder
      lein_service_user: cider-ci_builder

    - role: lein-service
      lein_service_name: cider-ci_dispatcher
      lein_service_app_dir: /var/local/cider-ci/dispatcher
      lein_service_user: cider-ci_dispatcher

    - role: lein-service
      lein_service_name: cider-ci_repository
      lein_service_app_dir: /var/local/cider-ci/repository
      lein_service_user: cider-ci_repository

    - role: lein-service
      lein_service_name: cider-ci_storage
      lein_service_app_dir: /var/local/cider-ci/storage
      lein_service_user: cider-ci_storage

    - role: db-backups

    - role: server-set-data

    - role: server-reverse-proxy

