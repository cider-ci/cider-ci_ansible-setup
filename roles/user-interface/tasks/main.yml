- name: Install dependencies
  apt: pkg={{item}} state=present update_cache=yes cache_valid_time=3600
  with_items: 
    - nodejs

- name: Create target dir 
  file: path={{ui_root_path}}
        owner={{user_interface_user}}
        group={{user_interface_user}}
        state=directory
        mode=0755

- stat: path="{{cider_ci_user_interface_git_repo}}/.git"
  register: cider_ci_user_interface_git_dir_stat


- shell: cd {{ui_root_path}} && git remote set-url origin {{cider_ci_user_interface_git_repo}}
  when: cider_ci_user_interface_git_dir_stat.stat.isdir is defined and cider_ci_user_interface_git_dir_stat.stat.isdir == true
  changed_when: False

- name: Git clone or update project
  git:  repo={{cider_ci_user_interface_git_repo}}
        accept_hostkey=yes
        dest={{ui_root_path}}
        version={{git_ref}}
        update=yes
  register: git_clone_or_update

- shell: cd {{ui_root_path}} && git submodule init && git submodule update
  when: git_clone_or_update.changed
  # somehow submodules get not set properly on update 

- debug: var=git_clone_or_update

- file: path={{ui_root_path}} 
        owner={{user_interface_user}}
        group={{user_interface_user}}
        recurse=true
  changed_when: false

- set_fact: user_interface_restart=True
  when: git_clone_or_update.changed 

### Bundle #####################################################################

- name: Bundle Jruby
  shell: su -l -s /bin/bash -c 'source /etc/profile.d/rbenv-load.sh 
          && rbenv-load 
          && cd {{ui_root_path}}
          && export RAILS_ENV={{rails_env}} 
          && export RBENV_VERSION={{rubies.jruby.version}} 
          && bundle install --deployment' {{user_interface_user}}
         executable=/bin/bash
  register: bundle_jruby
  changed_when: bundle_jruby.stdout | match(".*Installing.*")


- name: Bundle MRI
  shell: su -l -s /bin/bash -c 'source /etc/profile.d/rbenv-load.sh 
          && rbenv-load 
          && cd {{ui_root_path}}
          && export RAILS_ENV={{rails_env}} 
          && export RBENV_VERSION={{rubies.mri.version}} 
          && bundle install --deployment' {{user_interface_user}} 
         executable=/bin/bash
  register: bundle_mri
  changed_when: bundle_mri.stdout | match(".*Installing.*")


### Settings ##################################################################

- template: src=settings.yml
            dest={{ui_root_path}}/config/settings.local.yml
  register: settings

- set_fact: user_interface_restart=True
  when: settings.changed 


### Secret ####################################################################

- template: src=secrets.yml
            dest={{ui_root_path}}/config/secrets.yml
            owner={{user_interface_user}}
            group={{user_interface_user}}
            mode=0600
  register: secret

- set_fact: user_interface_restart=True
  when: secret.changed 


### Database ##################################################################

- name: Configure database
  template: src=database.yml
            dest={{ui_root_path}}/config/database.yml
            owner={{user_interface_user}}
            mode=0755
  register: database_config 

- name: Migrate
  shell:  su -l -s /bin/bash -c 'source /etc/profile.d/rbenv-load.sh 
            && rbenv-load 
            && cd {{ui_root_path}}
            && export RAILS_ENV={{rails_env}} 
            && export RBENV_VERSION={{rubies.mri.version}} 
            && bundle exec rake db:create db:migrate' {{user_interface_user}}
          executable=/bin/bash
  register: migrate
  changed_when: not migrate.stdout | match("")

- set_fact: user_interface_restart=True
  when: database_config.changed 


### Admin 

- set_fact: system_admin_login=system_admin
  when: system_admin_login is not defined

### Seed 

- template: src=seeds.rb
             dest={{ui_root_path}}/db/seeds.rb
             owner={{user_interface_user}}
  register: seedfile

- shell:  su -l -s /bin/bash -c 'source /etc/profile.d/rbenv-load.sh 
            && rbenv-load 
            && cd {{ui_root_path}}
            && export RAILS_ENV={{rails_env}} 
            && export RBENV_VERSION={{rubies.mri.version}} 
            && bundle exec rake db:seed' {{user_interface_user}} 
          executable=/bin/bash
  register: seed
  changed_when: false

#- debug: var=seed


### Assets ####################################################################

- name: Precompile assets 
  shell:  su -l -s /bin/bash -c 'source /etc/profile.d/rbenv-load.sh 
            && rbenv-load 
            && cd {{ui_root_path}}
            && export RAILS_ENV={{rails_env}} 
            && export RBENV_VERSION={{rubies.mri.version}} 
            && rm -rf public/assets/*
            && rm -rf tmp/cache/*
            && bundle exec rake assets:precompile' {{user_interface_user}} 
          executable=/bin/bash
  register: precompile_assets
  changed_when: not precompile_assets.stderr | match("")

### logrotation ################################################################

- template: src=logrotate
            dest=/etc/logrotate.d/{{user_interface_service_name}}

### Shared Service #############################################################

- template: src=wrapper.sh
            dest={{user_interface_wrapper_bin}}
            mode=755
  register: user_interface_wrapper

- set_fact: user_interface_restart=True
  when: user_interface_wrapper.changed

- template: src=start.sh
            dest={{user_interface_service_bin}}
            mode=755
  register: user_interface_start

- set_fact: user_interface_restart=True
  when: user_interface_start.changed



### Upstart Service ############################################################

- template: src=init.conf
            dest=/etc/init/cider-ci_user-interface.conf 
  register: init_script
  when: ansible_distribution_release == 'trusty'

- set_fact: user_interface_restart=True
  when: ansible_distribution_release == 'trusty' and init_script.changed 


### Systemd Service ############################################################

- template: src=service.conf
            dest=/etc/systemd/system/{{user_interface_service_name}}.service
  register: user_interface_systemd_service
  when: ansible_distribution_release == 'wheezy'

- set_fact: user_interface_restart=True
  when: ansible_distribution_release == 'wheezy' and user_interface_systemd_service.changed

### enable

- service: name={{user_interface_service_name}} enabled=yes


### (re-) start service #######################################################

- command: logrotate -f /etc/logrotate.d/{{user_interface_service_name}}
  when: lein_git_service_restart


- service:  name={{user_interface_service_name}}
            state=restarted
  when: user_interface_restart

- service:  name={{user_interface_service_name}}
            state=started

